"use strict";(()=>{var e={};e.id=9655,e.ids=[9655],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},35900:e=>{e.exports=require("pg")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},22037:e=>{e.exports=require("os")},63477:e=>{e.exports=require("querystring")},76224:e=>{e.exports=require("tty")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},91877:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>w,requestAsyncStorage:()=>q,routeModule:()=>h,serverHooks:()=>f,staticGenerationAsyncStorage:()=>b});var s={};r.r(s),r.d(s,{GET:()=>y,POST:()=>x});var i=r(49303),o=r(88716),n=r(60670),a=r(87070),u=r(64099),d=r(54674),l=r(89773),p=r(18819),c=r(57745),m=r(81445),g=r(9576);async function x(e){try{let t=await (0,u.getSession)();if(!t?.user)return a.NextResponse.json({error:"Unauthorized"},{status:401});let{title:r,content:s,storyType:i,visibility:o,tags:n=[],published:m=!1,media:x=[]}=await e.json();if(!r||!s||!i)return a.NextResponse.json({error:"Title, content, and story type are required"},{status:400});let[y]=await d.db.select({id:l.users.id}).from(l.users).where((0,c.eq)(l.users.auth0Id,t.user.sub)).limit(1);if(!y)return a.NextResponse.json({error:"User not found"},{status:404});let h=(0,g.Z)(),[q]=await d.db.insert(p.stories).values({id:h,userId:y.id,organizationId:y.organizationId,title:r,content:s,storyType:i,visibility:o,published:m,publishedAt:m?new Date:null,createdAt:new Date,updatedAt:new Date}).returning();if(n.length>0){let e=n.map(e=>({id:(0,g.Z)(),storyId:h,tag:e,createdAt:new Date}));await d.db.insert(p.storyTags).values(e)}if(x.length>0){let e=x.map(e=>{let t="document";return e.type?.startsWith("image/")||e.url?.match(/\.(jpg|jpeg|png|gif|webp)$/i)?t="image":(e.type?.startsWith("video/")||e.url?.match(/\.(mp4|mov|avi|webm)$/i))&&(t="video"),{id:(0,g.Z)(),storyId:h,type:t,url:e.url,thumbnailUrl:"image"===t?e.url:null,metadata:{originalName:e.name,size:e.size,mimeType:e.type,s3Key:e.key},createdAt:new Date}});await d.db.insert(p.storyMedia).values(e)}return a.NextResponse.json(q)}catch(e){return a.NextResponse.json({error:"Failed to create story"},{status:500})}}async function y(e){try{let t=await (0,u.getSession)();if(!t?.user)return a.NextResponse.json({error:"Unauthorized"},{status:401});let[r]=await d.db.select({id:l.users.id,role:l.users.role}).from(l.users).where((0,c.eq)(l.users.auth0Id,t.user.sub)).limit(1);if(!r)return a.NextResponse.json({error:"User not found"},{status:404});let{searchParams:s}=new URL(e.url),i=s.get("filter")||"all";s.get("visibility"),s.get("type");let o=[];"mine"===i?o=[(0,c.eq)(p.stories.userId,r.id)]:(o=[(0,c.eq)(p.stories.userId,r.id),(0,c.eq)(p.stories.visibility,"public"),(0,c.xD)((0,c.eq)(p.stories.visibility,"anonymous"),(0,c.eq)(p.stories.published,!0))],r.organizationId&&o.push((0,c.xD)((0,c.eq)(p.stories.visibility,"organization"),(0,c.eq)(p.stories.organizationId,r.organizationId))));let n=d.db.select({id:p.stories.id,title:p.stories.title,content:p.stories.content,storyType:p.stories.storyType,visibility:p.stories.visibility,published:p.stories.published,publishedAt:p.stories.publishedAt,createdAt:p.stories.createdAt,updatedAt:p.stories.updatedAt,userId:p.stories.userId,organizationId:p.stories.organizationId}).from(p.stories).where((0,c.or)(...o)).orderBy((0,m.C)(p.stories.createdAt)),g=(await n).map(e=>{if("anonymous"===e.visibility&&e.userId!==r.id){let{userId:t,...r}=e;return r}return e});return a.NextResponse.json(g)}catch(e){return a.NextResponse.json({error:"Failed to fetch stories"},{status:500})}}let h=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/stories/route",pathname:"/api/stories",filename:"route",bundlePath:"app/api/stories/route"},resolvedPagePath:"/Users/benknight/Code/JusticeHub/src/app/api/stories/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:q,staticGenerationAsyncStorage:b,serverHooks:f}=h,v="/api/stories/route";function w(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:b})}},9576:(e,t,r)=>{r.d(t,{Z:()=>d});var s=r(6113),i=r.n(s);let o={randomUUID:i().randomUUID},n=new Uint8Array(256),a=n.length,u=[];for(let e=0;e<256;++e)u.push((e+256).toString(16).slice(1));let d=function(e,t,r){if(o.randomUUID&&!t&&!e)return o.randomUUID();let s=(e=e||{}).random||(e.rng||function(){return a>n.length-16&&(i().randomFillSync(n),a=0),n.slice(a,a+=16)})();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=s[e];return t}return function(e,t=0){return u[e[t+0]]+u[e[t+1]]+u[e[t+2]]+u[e[t+3]]+"-"+u[e[t+4]]+u[e[t+5]]+"-"+u[e[t+6]]+u[e[t+7]]+"-"+u[e[t+8]]+u[e[t+9]]+"-"+u[e[t+10]]+u[e[t+11]]+u[e[t+12]]+u[e[t+13]]+u[e[t+14]]+u[e[t+15]]}(s)}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972,2707,8384,4099,4674],()=>r(91877));module.exports=s})();