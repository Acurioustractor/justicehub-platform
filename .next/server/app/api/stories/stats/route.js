"use strict";(()=>{var e={};e.id=2655,e.ids=[2655],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},35900:e=>{e.exports=require("pg")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},22037:e=>{e.exports=require("os")},63477:e=>{e.exports=require("querystring")},76224:e=>{e.exports=require("tty")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},14895:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>f,patchFetch:()=>x,requestAsyncStorage:()=>b,routeModule:()=>h,serverHooks:()=>m,staticGenerationAsyncStorage:()=>g});var r={};i.r(r),i.d(r,{GET:()=>y});var s=i(49303),a=i(88716),o=i(60670),n=i(87070),d=i(64099),l=i(54674),u=i(89773),p=i(57745),c=i(92231);async function y(e){try{let e=await (0,d.getSession)();if(!e?.user)return n.NextResponse.json({error:"Unauthorized"},{status:401});let[t]=await l.db.select().from(u.users).where((0,p.eq)(u.users.auth0Id,e.user.sub)).limit(1);if(!t)return n.NextResponse.json({error:"User not found"},{status:404});let i=await c.$.getStoryStats(t);return n.NextResponse.json(i)}catch(e){return n.NextResponse.json({error:"Failed to fetch statistics"},{status:500})}}let h=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/stories/stats/route",pathname:"/api/stories/stats",filename:"route",bundlePath:"app/api/stories/stats/route"},resolvedPagePath:"/Users/benknight/Code/JusticeHub/src/app/api/stories/stats/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:b,staticGenerationAsyncStorage:g,serverHooks:m}=h,f="/api/stories/stats/route";function x(){return(0,o.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:g})}},55260:(e,t,i)=>{function r({story:e,viewer:t,authorProfile:i}){if(t&&e.userId===t.id)return!0;switch(e.visibility){case"public":return!0;case"anonymous":return!0===e.published;case"organization":if(!t)return!1;return t.organizationId===e.organizationId;case"mentors":var r,s;if(!t)return!1;return"mentor"===t.role&&(e.userId,t.id,!1);default:return!1}}function s(e){if(!e)return{or:[{visibility:"public"},{and:[{visibility:"anonymous"},{published:!0}]}]};let t=[{userId:e.id},{visibility:"public"},{and:[{visibility:"anonymous"},{published:!0}]}];return e.organizationId&&t.push({and:[{visibility:"organization"},{organizationId:e.organizationId}]}),e.role,{or:t}}function a(e,t){let i={...e};return"anonymous"!==e.visibility||t&&e.userId===t.id?i:(delete i.userId,delete i.author,{id:i.id,title:i.title,content:i.content,storyType:i.storyType,visibility:i.visibility,tags:i.tags,media:i.media,published:i.published,publishedAt:i.publishedAt,createdAt:i.createdAt,updatedAt:i.updatedAt})}i.d(t,{U4:()=>r,h_:()=>s,s6:()=>a})},92231:(e,t,i)=>{i.d(t,{$:()=>p});var r=i(54674),s=i(18819),a=i(89773),o=i(57745),n=i(34149),d=i(81445),l=i(55260);class u{async getUnifiedStories(e,t){let i=e.limit||20,r=e.offset||0,s=[],a=[];"airtable"!==e.source&&(s=await this.getLocalStories(e,t)),"local"!==e.source&&(a=await this.getAirtableStories(e,t));let o=[...s,...a],n=this.sortStories(o,e.sortBy||"createdAt",e.sortOrder||"desc");return{stories:n.slice(r,r+i),total:n.length,hasMore:n.length>r+i}}async getLocalStories(e,t){try{let i=(0,l.h_)(t),u=[];i.or&&(u=i.or),e.visibility&&e.visibility.length>0&&u.push((0,o.d3)(s.stories.visibility,e.visibility)),e.storyType&&e.storyType.length>0&&u.push((0,o.d3)(s.stories.storyType,e.storyType)),void 0!==e.published&&u.push((0,o.eq)(s.stories.published,e.published)),e.organizationId&&u.push((0,o.eq)(s.stories.organizationId,e.organizationId));let p=r.db.select({story:s.stories,author:{id:a.users.id,email:a.users.email,name:(0,n.i6)`${a.users.profile}->>'name'`,organizationId:a.users.organizationId}}).from(s.stories).leftJoin(a.users,(0,o.eq)(s.stories.userId,a.users.id)).where(u.length>0?(0,o.or)(...u):void 0).orderBy((0,d.C)(s.stories.createdAt)),c=await p,y=c.map(e=>e.story.id),h=(await r.db.select().from(s.storyTags).where((0,o.d3)(s.storyTags.storyId,y))).reduce((e,t)=>(e[t.storyId]||(e[t.storyId]=[]),e[t.storyId].push(t.tag),e),{}),b=(await r.db.select().from(s.storyMedia).where((0,o.d3)(s.storyMedia.storyId,y))).reduce((e,t)=>(e[t.storyId]||(e[t.storyId]=[]),e[t.storyId].push(t),e),{});return c.map(({story:e,author:i})=>({id:e.id,title:e.title,content:e.content,storyType:e.storyType,visibility:e.visibility,published:e.published,publishedAt:e.publishedAt,createdAt:e.createdAt,updatedAt:e.updatedAt,source:"local",tags:h[e.id]||[],media:b[e.id]||[],author:"anonymous"===e.visibility&&e.userId!==t?.id?{name:"Anonymous"}:{id:i?.id,name:i?.name||"Unknown",organization:i?.organizationId},metadata:{wordCount:e.content.split(/\s+/).length,readingTime:Math.ceil(e.content.split(/\s+/).length/200)}}))}catch(e){return[]}}async getAirtableStories(e,t){try{let i=new URLSearchParams;e.tags&&e.tags.length>0&&i.append("tags",e.tags.join(",")),e.search&&i.append("search",e.search);let r=await fetch(`/api/airtable/stories?${i}`,{headers:{"x-user-id":t?.id||"","x-user-role":t?.role||"","x-organization-id":t?.organizationId||""}});if(!r.ok)throw Error("Failed to fetch Airtable stories");return(await r.json()).stories.map(e=>({id:`airtable_${e.id}`,title:e.fields.Title||"Untitled",content:e.fields.Content||"",storyType:e.fields.Type||"reflection",visibility:e.fields.Visibility||"public",published:e.fields.Published||!1,publishedAt:e.fields.PublishedDate?new Date(e.fields.PublishedDate):null,createdAt:new Date(e.createdTime),updatedAt:new Date(e.fields.LastModified||e.createdTime),source:"airtable",tags:e.fields.Tags||[],media:e.fields.Attachments?.map(e=>({id:e.id,type:e.type.startsWith("image/")?"image":"video",url:e.url,thumbnailUrl:e.thumbnails?.large?.url,metadata:{filename:e.filename,size:e.size,type:e.type}}))||[],author:{name:e.fields.AuthorName||"Community Member",organization:e.fields.Organization},metadata:{wordCount:e.fields.WordCount,readingTime:e.fields.ReadingTime,lastSyncedAt:new Date}}))}catch(e){return[]}}sortStories(e,t,i){return e.sort((e,r)=>{let s=0;switch(t){case"title":s=e.title.localeCompare(r.title);break;case"publishedAt":let a=e.publishedAt||e.createdAt,o=r.publishedAt||r.createdAt;s=a.getTime()-o.getTime();break;default:s=e.createdAt.getTime()-r.createdAt.getTime()}return"desc"===i?-s:s})}async searchStories(e,t){let{stories:i}=await this.getUnifiedStories({search:e,published:!0,limit:50},t),r=e.toLowerCase();return i.filter(e=>e.title.toLowerCase().includes(r)||e.content.toLowerCase().includes(r)||e.tags?.some(e=>e.toLowerCase().includes(r)))}async getStoryStats(e){let{stories:t}=await this.getUnifiedStories({limit:1e3},e),i={total:t.length,bySource:{local:0,airtable:0},byType:{},byVisibility:{},recentlyPublished:0},r=new Date;return r.setDate(r.getDate()-30),t.forEach(e=>{i.bySource[e.source]++,i.byType[e.storyType]=(i.byType[e.storyType]||0)+1,i.byVisibility[e.visibility]=(i.byVisibility[e.visibility]||0)+1,e.publishedAt&&e.publishedAt>r&&i.recentlyPublished++}),i}}let p=new u}};var t=require("../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),r=t.X(0,[8948,5972,2707,8384,4099,4674],()=>i(14895));module.exports=r})();