"use strict";(()=>{var e={};e.id=9985,e.ids=[9985],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},35900:e=>{e.exports=require("pg")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},22037:e=>{e.exports=require("os")},63477:e=>{e.exports=require("querystring")},76224:e=>{e.exports=require("tty")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},72412:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>w,patchFetch:()=>j,requestAsyncStorage:()=>m,routeModule:()=>f,serverHooks:()=>q,staticGenerationAsyncStorage:()=>g});var s={};r.r(s),r.d(s,{DELETE:()=>b,GET:()=>x,PUT:()=>y});var i=r(49303),o=r(88716),n=r(60670),a=r(87070),u=r(64099),d=r(54674),p=r(89773),l=r(18819),c=r(57745),h=r(55260);async function x(e,{params:t}){try{let e=await (0,u.getSession)();if(!e?.user)return a.NextResponse.json({error:"Unauthorized"},{status:401});let[r]=await d.db.select().from(p.users).where((0,c.eq)(p.users.auth0Id,e.user.sub)).limit(1);if(!r)return a.NextResponse.json({error:"User not found"},{status:404});let[s]=await d.db.select().from(l.stories).where((0,c.eq)(l.stories.id,t.id)).limit(1);if(!s)return a.NextResponse.json({error:"Story not found"},{status:404});if(!(0,h.U4)({story:s,viewer:r}))return a.NextResponse.json({error:"Forbidden"},{status:403});let i=await d.db.select().from(l.storyTags).where((0,c.eq)(l.storyTags.storyId,s.id)),o=await d.db.select().from(l.storyMedia).where((0,c.eq)(l.storyMedia.storyId,s.id)),n=(0,h.s6)(s,r);return a.NextResponse.json({...n,tags:i.map(e=>e.tag),media:o})}catch(e){return a.NextResponse.json({error:"Failed to fetch story"},{status:500})}}async function y(e,{params:t}){try{let r=await (0,u.getSession)();if(!r?.user)return a.NextResponse.json({error:"Unauthorized"},{status:401});let[s]=await d.db.select({id:p.users.id}).from(p.users).where((0,c.eq)(p.users.auth0Id,r.user.sub)).limit(1);if(!s)return a.NextResponse.json({error:"User not found"},{status:404});let[i]=await d.db.select().from(l.stories).where((0,c.xD)((0,c.eq)(l.stories.id,t.id),(0,c.eq)(l.stories.userId,s.id))).limit(1);if(!i)return a.NextResponse.json({error:"Story not found or unauthorized"},{status:404});let{title:o,content:n,storyType:h,visibility:x,tags:y=[],published:b}=await e.json(),[f]=await d.db.update(l.stories).set({title:o,content:n,storyType:h,visibility:x,published:b,publishedAt:b&&!i.published?new Date:i.publishedAt,updatedAt:new Date}).where((0,c.eq)(l.stories.id,t.id)).returning();if(await d.db.delete(l.storyTags).where((0,c.eq)(l.storyTags.storyId,t.id)),y.length>0){let e=y.map(e=>({id:crypto.randomUUID(),storyId:t.id,tag:e,createdAt:new Date}));await d.db.insert(l.storyTags).values(e)}return a.NextResponse.json(f)}catch(e){return a.NextResponse.json({error:"Failed to update story"},{status:500})}}async function b(e,{params:t}){try{let e=await (0,u.getSession)();if(!e?.user)return a.NextResponse.json({error:"Unauthorized"},{status:401});let[r]=await d.db.select({id:p.users.id}).from(p.users).where((0,c.eq)(p.users.auth0Id,e.user.sub)).limit(1);if(!r)return a.NextResponse.json({error:"User not found"},{status:404});let[s]=await d.db.select().from(l.stories).where((0,c.xD)((0,c.eq)(l.stories.id,t.id),(0,c.eq)(l.stories.userId,r.id))).limit(1);if(!s)return a.NextResponse.json({error:"Story not found or unauthorized"},{status:404});return await d.db.delete(l.stories).where((0,c.eq)(l.stories.id,t.id)),a.NextResponse.json({success:!0})}catch(e){return a.NextResponse.json({error:"Failed to delete story"},{status:500})}}let f=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/stories/[id]/route",pathname:"/api/stories/[id]",filename:"route",bundlePath:"app/api/stories/[id]/route"},resolvedPagePath:"/Users/benknight/Code/JusticeHub/src/app/api/stories/[id]/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:q}=f,w="/api/stories/[id]/route";function j(){return(0,n.patchFetch)({serverHooks:q,staticGenerationAsyncStorage:g})}},55260:(e,t,r)=>{function s({story:e,viewer:t,authorProfile:r}){if(t&&e.userId===t.id)return!0;switch(e.visibility){case"public":return!0;case"anonymous":return!0===e.published;case"organization":if(!t)return!1;return t.organizationId===e.organizationId;case"mentors":var s,i;if(!t)return!1;return"mentor"===t.role&&(e.userId,t.id,!1);default:return!1}}function i(e){if(!e)return{or:[{visibility:"public"},{and:[{visibility:"anonymous"},{published:!0}]}]};let t=[{userId:e.id},{visibility:"public"},{and:[{visibility:"anonymous"},{published:!0}]}];return e.organizationId&&t.push({and:[{visibility:"organization"},{organizationId:e.organizationId}]}),e.role,{or:t}}function o(e,t){let r={...e};return"anonymous"!==e.visibility||t&&e.userId===t.id?r:(delete r.userId,delete r.author,{id:r.id,title:r.title,content:r.content,storyType:r.storyType,visibility:r.visibility,tags:r.tags,media:r.media,published:r.published,publishedAt:r.publishedAt,createdAt:r.createdAt,updatedAt:r.updatedAt})}r.d(t,{U4:()=>s,h_:()=>i,s6:()=>o})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972,2707,8384,4099,4674],()=>r(72412));module.exports=s})();