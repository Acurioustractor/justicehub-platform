"use strict";(()=>{var e={};e.id=2125,e.ids=[2125],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},35900:e=>{e.exports=require("pg")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},90385:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>w,patchFetch:()=>v,requestAsyncStorage:()=>f,routeModule:()=>R,serverHooks:()=>y,staticGenerationAsyncStorage:()=>g});var r={};s.r(r),s.d(r,{GET:()=>q,PATCH:()=>x});var n=s(49303),i=s(88716),o=s(60670),a=s(87070),u=s(54674),p=s(89773),l=s(57745),d=s(81445),h=s(34149),c=s(75571),m=s(95456);async function q(e){try{let t=await (0,c.getServerSession)(m.L);if(!t?.user?.id)return a.NextResponse.json({error:"Unauthorized"},{status:401});let[s]=await u.db.select().from(p.mentors).where((0,l.eq)(p.mentors.userId,t.user.id)).limit(1);if(!s)return a.NextResponse.json({error:"Mentor profile not found"},{status:404});let r=e.nextUrl.searchParams.get("status")||"pending",n=await u.db.select({id:p.mentorshipRelationships.id,status:p.mentorshipRelationships.status,requestMessage:p.mentorshipRelationships.requestMessage,requestedAt:p.mentorshipRelationships.requestedAt,respondedAt:p.mentorshipRelationships.respondedAt,responseMessage:p.mentorshipRelationships.responseMessage,goals:p.mentorshipRelationships.goals,meetingFrequency:p.mentorshipRelationships.meetingFrequency,communicationPreference:p.mentorshipRelationships.communicationPreference,startDate:p.mentorshipRelationships.startDate,youth:{id:p.youthProfiles.id,userId:p.youthProfiles.userId,name:p.users.name,email:p.users.email,bio:p.youthProfiles.bio,interests:p.youthProfiles.interests,goals:p.youthProfiles.goals}}).from(p.mentorshipRelationships).innerJoin(p.youthProfiles,(0,l.eq)(p.mentorshipRelationships.youthProfileId,p.youthProfiles.id)).innerJoin(p.users,(0,l.eq)(p.youthProfiles.userId,p.users.id)).where((0,l.xD)((0,l.eq)(p.mentorshipRelationships.mentorId,s.id),"all"===r?void 0:(0,l.eq)(p.mentorshipRelationships.status,r))).orderBy((0,d.C)(p.mentorshipRelationships.requestedAt));return a.NextResponse.json({requests:n,counts:{pending:await u.db.select({count:(0,h.i6)`count(*)`}).from(p.mentorshipRelationships).where((0,l.xD)((0,l.eq)(p.mentorshipRelationships.mentorId,s.id),(0,l.eq)(p.mentorshipRelationships.status,"pending"))).then(e=>e[0].count),active:await u.db.select({count:(0,h.i6)`count(*)`}).from(p.mentorshipRelationships).where((0,l.xD)((0,l.eq)(p.mentorshipRelationships.mentorId,s.id),(0,l.eq)(p.mentorshipRelationships.status,"active"))).then(e=>e[0].count)}})}catch(e){return a.NextResponse.json({error:"Failed to fetch requests"},{status:500})}}async function x(e){try{let t=await (0,c.getServerSession)(m.L);if(!t?.user?.id)return a.NextResponse.json({error:"Unauthorized"},{status:401});let{relationshipId:s,action:r,responseMessage:n}=await e.json();if(!s||!r)return a.NextResponse.json({error:"Missing required fields"},{status:400});let[i]=await u.db.select().from(p.mentors).where((0,l.eq)(p.mentors.userId,t.user.id)).limit(1);if(!i)return a.NextResponse.json({error:"Mentor profile not found"},{status:404});let[o]=await u.db.select().from(p.mentorshipRelationships).where((0,l.xD)((0,l.eq)(p.mentorshipRelationships.id,s),(0,l.eq)(p.mentorshipRelationships.mentorId,i.id))).limit(1);if(!o)return a.NextResponse.json({error:"Relationship not found"},{status:404});if("pending"!==o.status)return a.NextResponse.json({error:"Can only respond to pending requests"},{status:400});let d={respondedAt:new Date,responseMessage:n,updatedAt:new Date};if("accept"===r){if(i.currentMentees>=i.maxMentees)return a.NextResponse.json({error:"You are at full capacity"},{status:400});d.status="active",d.startDate=new Date,await u.db.update(p.mentors).set({currentMentees:i.currentMentees+1,updatedAt:new Date}).where((0,l.eq)(p.mentors.id,i.id))}else{if("decline"!==r)return a.NextResponse.json({error:"Invalid action"},{status:400});d.status="cancelled"}let[h]=await u.db.update(p.mentorshipRelationships).set(d).where((0,l.eq)(p.mentorshipRelationships.id,s)).returning();return a.NextResponse.json({message:`Request ${r}ed successfully`,relationship:h})}catch(e){return a.NextResponse.json({error:"Failed to respond to request"},{status:500})}}let R=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/mentors/requests/route",pathname:"/api/mentors/requests",filename:"route",bundlePath:"app/api/mentors/requests/route"},resolvedPagePath:"/Users/benknight/Code/JusticeHub/src/app/api/mentors/requests/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:y}=R,w="/api/mentors/requests/route";function v(){return(0,o.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:g})}},95456:(e,t,s)=>{s.d(t,{L:()=>u});var r=s(54674),n=s(89773),i=s(57745),o=s(75571),a=s.n(o);let u={providers:[(0,s(21474).Z)({clientId:process.env.AUTH0_CLIENT_ID||"",clientSecret:process.env.AUTH0_CLIENT_SECRET||"",issuer:process.env.AUTH0_ISSUER_BASE_URL||""})],session:{strategy:"jwt"},callbacks:{async jwt({token:e,user:t,account:s}){if(s&&t){e.accessToken=s.access_token;let o=t.id,a=await r.db.query.users.findFirst({where:(0,i.eq)(n.users.auth0Id,o)});if(!a){let[e]=await r.db.insert(n.users).values({auth0Id:o,email:t.email,name:t.name,role:"youth"}).returning();a=e}e.id=a.id,e.role=a.role}return e},session:async({session:e,token:t})=>(e.accessToken=t.accessToken,e.user&&(e.user.id=t.id,e.user.role=t.role),e)},secret:process.env.NEXTAUTH_SECRET};a()(u)}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[8948,5972,2707,8384,6546,4674],()=>s(90385));module.exports=r})();