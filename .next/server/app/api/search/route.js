"use strict";(()=>{var e={};e.id=280,e.ids=[280],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},35900:e=>{e.exports=require("pg")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},22037:e=>{e.exports=require("os")},63477:e=>{e.exports=require("querystring")},76224:e=>{e.exports=require("tty")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},58824:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>q,patchFetch:()=>C,requestAsyncStorage:()=>w,routeModule:()=>x,serverHooks:()=>T,staticGenerationAsyncStorage:()=>v});var s={};r.r(s),r.d(s,{GET:()=>b,POST:()=>m});var i=r(49303),a=r(88716),n=r(60670),o=r(87070),l=r(64099),u=r(54674),c=r(89773),d=r(57745),h=r(18819),p=r(34149),g=r(55260);class y{async search(e,t){let r=Date.now(),{query:s,filters:i={},limit:a=20,offset:n=0}=e,o=[...await this.searchLocalStories(e,t),...await this.searchAirtableStories(e,t)],l=this.rankResults(o,s),u=l.slice(n,n+a),c=this.generateFacets(l),d=await this.generateSuggestions(s,l),h=Date.now()-r;return{results:u,total:l.length,suggestions:d,facets:c,query:s,executionTime:h}}async searchLocalStories(e,t){let{query:r,filters:s={}}=e;try{let e=(0,g.h_)(t),i=[];e.or&&(i=[...e.or]);let a=[];r&&a.push((0,d.o$)(h.stories.title,`%${r}%`),(0,d.o$)(h.stories.content,`%${r}%`)),s.storyType?.length&&i.push((0,d.d3)(h.stories.storyType,s.storyType)),s.visibility?.length&&i.push((0,d.d3)(h.stories.visibility,s.visibility)),s.dateRange&&i.push((0,d.xD)((0,p.i6)`${h.stories.createdAt} >= ${s.dateRange.start}`,(0,p.i6)`${h.stories.createdAt} <= ${s.dateRange.end}`));let n=a.length>0?(0,d.xD)(...i,(0,d.or)(...a)):(0,d.xD)(...i),o=await u.db.select({story:h.stories,author:{id:c.users.id,name:(0,p.i6)`${c.users.profile}->>'name'`}}).from(h.stories).leftJoin(c.users,(0,d.eq)(h.stories.userId,c.users.id)).where(n),l=o.map(e=>e.story.id),y=(await u.db.select().from(h.storyTags).where((0,d.d3)(h.storyTags.storyId,l))).reduce((e,t)=>(e[t.storyId]||(e[t.storyId]=[]),e[t.storyId].push(t.tag),e),{});return o.map(({story:e,author:s})=>{let i=this.generateExcerpt(e.content,r),a=this.generateHighlights(e,r,y[e.id]||[]),n=this.calculateMatchScore(e,r,y[e.id]||[]);return{id:e.id,title:e.title,content:e.content,excerpt:i,highlights:a,matchScore:n,source:"local",storyType:e.storyType,visibility:e.visibility,author:"anonymous"===e.visibility&&e.userId!==t?.id?{name:"Anonymous"}:{id:s?.id,name:s?.name||"Unknown"},tags:y[e.id]||[],createdAt:e.createdAt,publishedAt:e.publishedAt||void 0}})}catch(e){return[]}}async searchAirtableStories(e,t){let{query:r,filters:s={}}=e;if("local"===s.source)return[];try{let e=new URLSearchParams({search:r});s.tags?.length&&e.append("tags",s.tags.join(","));let i=await fetch(`/api/airtable/search?${e}`,{headers:{"x-user-id":t?.id||"","x-user-role":t?.role||"","x-organization-id":t?.organizationId||""}});if(!i.ok)throw Error("Failed to search Airtable stories");return(await i.json()).results.map(e=>{let t=this.generateExcerpt(e.fields.Content||"",r),s=this.generateHighlights({title:e.fields.Title,content:e.fields.Content},r,e.fields.Tags||[]),i=this.calculateMatchScore({title:e.fields.Title,content:e.fields.Content},r,e.fields.Tags||[]);return{id:`airtable_${e.id}`,title:e.fields.Title||"Untitled",content:e.fields.Content||"",excerpt:t,highlights:s,matchScore:i,source:"airtable",storyType:e.fields.Type||"reflection",visibility:e.fields.Visibility||"public",author:{name:e.fields.AuthorName||"Community Member"},tags:e.fields.Tags||[],createdAt:new Date(e.createdTime),publishedAt:e.fields.PublishedDate?new Date(e.fields.PublishedDate):void 0}})}catch(e){return[]}}generateExcerpt(e,t,r=200){let s=e.replace(/<[^>]*>/g,"").trim(),i=t.toLowerCase(),a=s.toLowerCase().indexOf(i);if(-1===a)return s.length>r?s.substring(0,r)+"...":s;let n=Math.max(0,a-50),o=Math.min(s.length,a+t.length+150),l=s.substring(n,o);return n>0&&(l="..."+l),o<s.length&&(l+="..."),l}generateHighlights(e,t,r){let s=t.toLowerCase(),i={};if(e.title?.toLowerCase().includes(s)&&(i.title=this.highlightText(e.title,t)),e.content){let r=this.findContentHighlights(e.content,t);r.length>0&&(i.content=r)}let a=r.filter(e=>e.toLowerCase().includes(s));return a.length>0&&(i.tags=a),i}highlightText(e,t){let r=RegExp(`(${t})`,"gi");return e.replace(r,"<mark>$1</mark>")}findContentHighlights(e,t,r=3){let s=e.replace(/<[^>]*>/g,"").trim().split(/[.!?]+/),i=t.toLowerCase(),a=[];for(let e of s)e.toLowerCase().includes(i)&&a.length<r&&a.push(this.highlightText(e.trim(),t));return a}calculateMatchScore(e,t,r){let s=t.toLowerCase(),i=0;if(e.title?.toLowerCase().includes(s)&&(i+=10,e.title.toLowerCase()===s&&(i+=5)),e.content){let t=(e.content.toLowerCase().match(RegExp(s,"g"))||[]).length;i+=Math.min(2*t,10)}if(r.forEach(e=>{e.toLowerCase().includes(s)&&(i+=3)}),e.createdAt){let t=(Date.now()-new Date(e.createdAt).getTime())/864e5;t<7?i+=2:t<30&&(i+=1)}return i}rankResults(e,t){return e.sort((e,t)=>t.matchScore-e.matchScore)}generateFacets(e){let t={},r={},s={};return e.forEach(e=>{t[e.storyType]=(t[e.storyType]||0)+1,e.tags.forEach(e=>{r[e]=(r[e]||0)+1}),e.author?.name&&(s[e.author.name]=(s[e.author.name]||0)+1)}),{storyTypes:Object.entries(t).map(([e,t])=>({value:e,count:t})).sort((e,t)=>t.count-e.count),tags:Object.entries(r).map(([e,t])=>({value:e,count:t})).sort((e,t)=>t.count-e.count).slice(0,10),authors:Object.entries(s).map(([e,t])=>({value:e,count:t})).sort((e,t)=>t.count-e.count).slice(0,5)}}async generateSuggestions(e,t){let r=new Set;return t.forEach(t=>{t.tags.forEach(t=>{t.toLowerCase().includes(e.toLowerCase())&&r.add(t)})}),["reflection","milestone","challenge","achievement","goal","update"].forEach(t=>{t.includes(e.toLowerCase())&&t!==e.toLowerCase()&&r.add(t)}),Array.from(r).slice(0,5)}async getTrendingSearches(e=10){return["resilience","mental health","career goals","education","community","leadership","overcoming challenges","success story","mentorship","growth"].slice(0,e)}}let f=new y;async function m(e){try{let t=await (0,l.getSession)();if(!t?.user)return o.NextResponse.json({error:"Unauthorized"},{status:401});let[r]=await u.db.select().from(c.users).where((0,d.eq)(c.users.auth0Id,t.user.sub)).limit(1);if(!r)return o.NextResponse.json({error:"User not found"},{status:404});let s=await e.json(),i={query:s.query||"",filters:s.filters||{},limit:s.limit||20,offset:s.offset||0,includeContent:s.includeContent||!1,fuzzySearch:s.fuzzySearch||!0};if(!i.query||i.query.length<2)return o.NextResponse.json({error:"Search query must be at least 2 characters long"},{status:400});let a=await f.search(i,r);return o.NextResponse.json(a)}catch(e){return o.NextResponse.json({error:"Failed to perform search"},{status:500})}}async function b(e){try{let t=await (0,l.getSession)();if(!t?.user)return o.NextResponse.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),s=parseInt(r.get("limit")||"10"),i=await f.getTrendingSearches(s);return o.NextResponse.json({trending:i})}catch(e){return o.NextResponse.json({error:"Failed to fetch trending searches"},{status:500})}}let x=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/search/route",pathname:"/api/search",filename:"route",bundlePath:"app/api/search/route"},resolvedPagePath:"/Users/benknight/Code/JusticeHub/src/app/api/search/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:w,staticGenerationAsyncStorage:v,serverHooks:T}=x,q="/api/search/route";function C(){return(0,n.patchFetch)({serverHooks:T,staticGenerationAsyncStorage:v})}},55260:(e,t,r)=>{function s({story:e,viewer:t,authorProfile:r}){if(t&&e.userId===t.id)return!0;switch(e.visibility){case"public":return!0;case"anonymous":return!0===e.published;case"organization":if(!t)return!1;return t.organizationId===e.organizationId;case"mentors":var s,i;if(!t)return!1;return"mentor"===t.role&&(e.userId,t.id,!1);default:return!1}}function i(e){if(!e)return{or:[{visibility:"public"},{and:[{visibility:"anonymous"},{published:!0}]}]};let t=[{userId:e.id},{visibility:"public"},{and:[{visibility:"anonymous"},{published:!0}]}];return e.organizationId&&t.push({and:[{visibility:"organization"},{organizationId:e.organizationId}]}),e.role,{or:t}}function a(e,t){let r={...e};return"anonymous"!==e.visibility||t&&e.userId===t.id?r:(delete r.userId,delete r.author,{id:r.id,title:r.title,content:r.content,storyType:r.storyType,visibility:r.visibility,tags:r.tags,media:r.media,published:r.published,publishedAt:r.publishedAt,createdAt:r.createdAt,updatedAt:r.updatedAt})}r.d(t,{U4:()=>s,h_:()=>i,s6:()=>a})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972,2707,8384,4099,4674],()=>r(58824));module.exports=s})();