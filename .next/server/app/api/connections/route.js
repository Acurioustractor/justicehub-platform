"use strict";(()=>{var e={};e.id=5348,e.ids=[5348],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},35900:e=>{e.exports=require("pg")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},4683:(e,s,t)=>{t.r(s),t.d(s,{originalPathname:()=>f,patchFetch:()=>w,requestAsyncStorage:()=>y,routeModule:()=>g,serverHooks:()=>R,staticGenerationAsyncStorage:()=>x});var r={};t.r(r),t.d(r,{GET:()=>q});var i=t(49303),o=t(88716),n=t(60670),a=t(87070),u=t(54674),p=t(89773),l=t(57745),d=t(81445),h=t(34149),m=t(75571),c=t(95456);async function q(e){try{let e;let s=await (0,m.getServerSession)(c.L);if(!s?.user?.id)return a.NextResponse.json({error:"Unauthorized"},{status:401});let[t]=await u.db.select().from(p.youthProfiles).where((0,l.eq)(p.youthProfiles.userId,s.user.id)).limit(1),[r]=await u.db.select().from(p.mentors).where((0,l.eq)(p.mentors.userId,s.user.id)).limit(1);if(!t&&!r)return a.NextResponse.json({error:"Profile not found"},{status:404});e=t?await u.db.select({id:p.mentorshipRelationships.id,status:p.mentorshipRelationships.status,requestedAt:p.mentorshipRelationships.requestedAt,startDate:p.mentorshipRelationships.startDate,lastContactDate:p.mentorshipRelationships.lastContactDate,goals:p.mentorshipRelationships.goals,meetingFrequency:p.mentorshipRelationships.meetingFrequency,mentor:{id:p.mentors.id,userId:p.mentors.userId,name:p.users.name,title:p.mentors.title,expertise:p.mentors.expertise,availability:p.mentors.availability,rating:p.mentors.averageRating}}).from(p.mentorshipRelationships).innerJoin(p.mentors,(0,l.eq)(p.mentorshipRelationships.mentorId,p.mentors.id)).innerJoin(p.users,(0,l.eq)(p.mentors.userId,p.users.id)).where((0,l.eq)(p.mentorshipRelationships.youthProfileId,t.id)).orderBy((0,d.C)(p.mentorshipRelationships.updatedAt)):await u.db.select({id:p.mentorshipRelationships.id,status:p.mentorshipRelationships.status,requestedAt:p.mentorshipRelationships.requestedAt,startDate:p.mentorshipRelationships.startDate,lastContactDate:p.mentorshipRelationships.lastContactDate,goals:p.mentorshipRelationships.goals,meetingFrequency:p.mentorshipRelationships.meetingFrequency,youth:{id:p.youthProfiles.id,userId:p.youthProfiles.userId,name:p.users.name,bio:p.youthProfiles.bio,goals:p.youthProfiles.goals}}).from(p.mentorshipRelationships).innerJoin(p.youthProfiles,(0,l.eq)(p.mentorshipRelationships.youthProfileId,p.youthProfiles.id)).innerJoin(p.users,(0,l.eq)(p.youthProfiles.userId,p.users.id)).where((0,l.eq)(p.mentorshipRelationships.mentorId,r.id)).orderBy((0,d.C)(p.mentorshipRelationships.updatedAt));let i=await Promise.all(e.map(async e=>{let[t]=await u.db.select({count:(0,h.i6)`count(*)::int`}).from(p.messages).where((0,l.xD)((0,l.eq)(p.messages.relationshipId,e.id),(0,l.eq)(p.messages.read,!1),(0,h.i6)`${p.messages.senderId} != ${s.user.id}`)),[r]=await u.db.select({id:p.mentorshipSessions.id,title:p.mentorshipSessions.title,scheduledAt:p.mentorshipSessions.scheduledAt,meetingType:p.mentorshipSessions.meetingType}).from(p.mentorshipSessions).where((0,l.xD)((0,l.eq)(p.mentorshipSessions.relationshipId,e.id),(0,l.eg)(p.mentorshipSessions.scheduledAt,new Date),(0,l.or)((0,l.eq)(p.mentorshipSessions.status,"scheduled"),(0,l.eq)(p.mentorshipSessions.status,"confirmed")))).orderBy(p.mentorshipSessions.scheduledAt).limit(1);return{...e,unreadMessages:t?.count||0,upcomingSession:r}}));return a.NextResponse.json(i)}catch(e){return a.NextResponse.json({error:"Failed to fetch connections"},{status:500})}}let g=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/connections/route",pathname:"/api/connections",filename:"route",bundlePath:"app/api/connections/route"},resolvedPagePath:"/Users/benknight/Code/JusticeHub/src/app/api/connections/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:y,staticGenerationAsyncStorage:x,serverHooks:R}=g,f="/api/connections/route";function w(){return(0,n.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:x})}},95456:(e,s,t)=>{t.d(s,{L:()=>u});var r=t(54674),i=t(89773),o=t(57745),n=t(75571),a=t.n(n);let u={providers:[(0,t(21474).Z)({clientId:process.env.AUTH0_CLIENT_ID||"",clientSecret:process.env.AUTH0_CLIENT_SECRET||"",issuer:process.env.AUTH0_ISSUER_BASE_URL||""})],session:{strategy:"jwt"},callbacks:{async jwt({token:e,user:s,account:t}){if(t&&s){e.accessToken=t.access_token;let n=s.id,a=await r.db.query.users.findFirst({where:(0,o.eq)(i.users.auth0Id,n)});if(!a){let[e]=await r.db.insert(i.users).values({auth0Id:n,email:s.email,name:s.name,role:"youth"}).returning();a=e}e.id=a.id,e.role=a.role}return e},session:async({session:e,token:s})=>(e.accessToken=s.accessToken,e.user&&(e.user.id=s.id,e.user.role=s.role),e)},secret:process.env.NEXTAUTH_SECRET};a()(u)}};var s=require("../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e),r=s.X(0,[8948,5972,2707,8384,6546,4674],()=>t(4683));module.exports=r})();