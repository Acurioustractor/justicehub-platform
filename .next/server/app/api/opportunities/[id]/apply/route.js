"use strict";(()=>{var e={};e.id=7465,e.ids=[7465],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},35900:e=>{e.exports=require("pg")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},75017:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>A,patchFetch:()=>v,requestAsyncStorage:()=>h,routeModule:()=>w,serverHooks:()=>b,staticGenerationAsyncStorage:()=>q});var i={};r.r(i),r.d(i,{GET:()=>x,PATCH:()=>m,POST:()=>f});var s=r(49303),o=r(88716),n=r(60670),p=r(87070),a=r(54674),u=r(89773),l=r(57745),c=r(34149),d=r(75571),y=r(95456);async function x(e,{params:t}){try{let e=await (0,d.getServerSession)(y.L);if(!e?.user?.id)return p.NextResponse.json({error:"Unauthorized"},{status:401});let r=t.id,[i]=await a.db.select().from(u.opportunityApplications).where((0,l.xD)((0,l.eq)(u.opportunityApplications.opportunityId,r),(0,l.eq)(u.opportunityApplications.applicantId,e.user.id))).limit(1);if(!i)return p.NextResponse.json({application:null});return p.NextResponse.json({application:i})}catch(e){return p.NextResponse.json({error:"Failed to fetch application"},{status:500})}}async function f(e,{params:t}){try{let r=await (0,d.getServerSession)(y.L);if(!r?.user?.id)return p.NextResponse.json({error:"Unauthorized"},{status:401});let i=t.id,s=await e.json(),[o]=await a.db.select().from(u.opportunities).where((0,l.xD)((0,l.eq)(u.opportunities.id,i),(0,l.eq)(u.opportunities.status,"active"))).limit(1);if(!o)return p.NextResponse.json({error:"Opportunity not found or not accepting applications"},{status:404});if(o.applicationDeadline&&new Date>o.applicationDeadline)return p.NextResponse.json({error:"Application deadline has passed"},{status:400});if(o.spotsAvailable<=0)return p.NextResponse.json({error:"No spots available"},{status:400});if((await a.db.select().from(u.opportunityApplications).where((0,l.xD)((0,l.eq)(u.opportunityApplications.opportunityId,i),(0,l.eq)(u.opportunityApplications.applicantId,r.user.id))).limit(1)).length>0)return p.NextResponse.json({error:"You have already applied to this opportunity"},{status:400});let n=null;if("youth"===r.user.role){let[e]=await a.db.select({id:u.youthProfiles.id}).from(u.youthProfiles).where((0,l.eq)(u.youthProfiles.userId,r.user.id)).limit(1);n=e?.id}let[x]=await a.db.insert(u.opportunityApplications).values({opportunityId:i,applicantId:r.user.id,youthProfileId:n,status:s.submitNow?"submitted":"draft",coverLetter:s.coverLetter,resume:s.resume,portfolio:s.portfolio,customResponses:s.customResponses||{},references:s.references||[],source:s.source||"direct",referredBy:s.referredBy,submittedAt:s.submitNow?new Date:null}).returning();return s.submitNow&&await a.db.update(u.opportunities).set({applicationCount:(0,c.i6)`${u.opportunities.applicationCount} + 1`}).where((0,l.eq)(u.opportunities.id,i)),p.NextResponse.json({message:s.submitNow?"Application submitted successfully":"Application draft saved",application:x})}catch(e){return p.NextResponse.json({error:"Failed to submit application"},{status:500})}}async function m(e,{params:t}){try{let r=await (0,d.getServerSession)(y.L);if(!r?.user?.id)return p.NextResponse.json({error:"Unauthorized"},{status:401});let i=t.id,s=await e.json(),[o]=await a.db.select().from(u.opportunityApplications).where((0,l.xD)((0,l.eq)(u.opportunityApplications.opportunityId,i),(0,l.eq)(u.opportunityApplications.applicantId,r.user.id))).limit(1);if(!o)return p.NextResponse.json({error:"Application not found"},{status:404});if("draft"!==o.status)return p.NextResponse.json({error:"Can only update draft applications"},{status:400});let n={...s,updatedAt:new Date};s.submitNow&&(n.status="submitted",n.submittedAt=new Date,delete n.submitNow,await a.db.update(u.opportunities).set({applicationCount:(0,c.i6)`${u.opportunities.applicationCount} + 1`}).where((0,l.eq)(u.opportunities.id,i)));let[x]=await a.db.update(u.opportunityApplications).set(n).where((0,l.xD)((0,l.eq)(u.opportunityApplications.opportunityId,i),(0,l.eq)(u.opportunityApplications.applicantId,r.user.id))).returning();return p.NextResponse.json({message:s.submitNow?"Application submitted successfully":"Application updated successfully",application:x})}catch(e){return p.NextResponse.json({error:"Failed to update application"},{status:500})}}let w=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/opportunities/[id]/apply/route",pathname:"/api/opportunities/[id]/apply",filename:"route",bundlePath:"app/api/opportunities/[id]/apply/route"},resolvedPagePath:"/Users/benknight/Code/JusticeHub/src/app/api/opportunities/[id]/apply/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:h,staticGenerationAsyncStorage:q,serverHooks:b}=w,A="/api/opportunities/[id]/apply/route";function v(){return(0,n.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:q})}},95456:(e,t,r)=>{r.d(t,{L:()=>a});var i=r(54674),s=r(89773),o=r(57745),n=r(75571),p=r.n(n);let a={providers:[(0,r(21474).Z)({clientId:process.env.AUTH0_CLIENT_ID||"",clientSecret:process.env.AUTH0_CLIENT_SECRET||"",issuer:process.env.AUTH0_ISSUER_BASE_URL||""})],session:{strategy:"jwt"},callbacks:{async jwt({token:e,user:t,account:r}){if(r&&t){e.accessToken=r.access_token;let n=t.id,p=await i.db.query.users.findFirst({where:(0,o.eq)(s.users.auth0Id,n)});if(!p){let[e]=await i.db.insert(s.users).values({auth0Id:n,email:t.email,name:t.name,role:"youth"}).returning();p=e}e.id=p.id,e.role=p.role}return e},session:async({session:e,token:t})=>(e.accessToken=t.accessToken,e.user&&(e.user.id=t.id,e.user.role=t.role),e)},secret:process.env.NEXTAUTH_SECRET};p()(a)}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[8948,5972,2707,8384,6546,4674],()=>r(75017));module.exports=i})();