"use strict";(()=>{var e={};e.id=4115,e.ids=[4115],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},35900:e=>{e.exports=require("pg")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},24733:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>z,patchFetch:()=>v,requestAsyncStorage:()=>w,routeModule:()=>q,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h});var r={};i.r(r),i.d(r,{DELETE:()=>m,GET:()=>y,PATCH:()=>x});var o=i(49303),s=i(88716),n=i(60670),a=i(87070),p=i(54674),u=i(89773),d=i(57745),c=i(34149),l=i(75571),g=i(95456);async function y(e,{params:t}){try{let e=t.id,i=await (0,l.getServerSession)(g.L),r=i?.user?.id,[o]=await p.db.select({opportunity:u.opportunities,organization:{id:u.organizations.id,name:u.organizations.name,logo:u.organizations.logo,website:u.organizations.website,description:u.organizations.description}}).from(u.opportunities).innerJoin(u.organizations,(0,d.eq)(u.opportunities.organizationId,u.organizations.id)).where((0,d.eq)(u.opportunities.id,e)).limit(1);if(!o||!("active"===o.opportunity.status||r&&o.opportunity.createdBy===r||r&&i.user.organizationId===o.opportunity.organizationId))return a.NextResponse.json({error:"Opportunity not found"},{status:404});let s=!1,n=null;if(r){let[t]=await p.db.select().from(u.savedOpportunities).where((0,d.xD)((0,d.eq)(u.savedOpportunities.opportunityId,e),(0,d.eq)(u.savedOpportunities.userId,r))).limit(1);s=!!t;let[i]=await p.db.select().from(u.opportunityApplications).where((0,d.xD)((0,d.eq)(u.opportunityApplications.opportunityId,e),(0,d.eq)(u.opportunityApplications.applicantId,r))).limit(1);i&&(n={id:i.id,status:i.status,submittedAt:i.submittedAt})}await p.db.update(u.opportunities).set({viewCount:(0,c.i6)`${u.opportunities.viewCount} + 1`}).where((0,d.eq)(u.opportunities.id,e));let y=await p.db.select({id:u.opportunities.id,title:u.opportunities.title,type:u.opportunities.type,organization:u.organizations.name,location:u.opportunities.location,applicationDeadline:u.opportunities.applicationDeadline}).from(u.opportunities).innerJoin(u.organizations,(0,d.eq)(u.opportunities.organizationId,u.organizations.id)).where((0,d.xD)((0,d.eq)(u.opportunities.status,"active"),(0,d.eq)(u.opportunities.type,o.opportunity.type),(0,c.i6)`${u.opportunities.id} != ${e}`)).limit(3);return a.NextResponse.json({...o.opportunity,organization:o.organization,saved:s,application:n,similarOpportunities:y})}catch(e){return a.NextResponse.json({error:"Failed to fetch opportunity"},{status:500})}}async function x(e,{params:t}){try{let i=await (0,l.getServerSession)(g.L);if(!i?.user?.id)return a.NextResponse.json({error:"Unauthorized"},{status:401});let r=t.id,o=await e.json(),[s]=await p.db.select().from(u.opportunities).where((0,d.eq)(u.opportunities.id,r)).limit(1);if(!s)return a.NextResponse.json({error:"Opportunity not found"},{status:404});if(!(s.createdBy===i.user.id||i.user.organizationId&&i.user.organizationId===s.organizationId))return a.NextResponse.json({error:"Unauthorized to edit this opportunity"},{status:403});"active"===o.status&&"active"!==s.status&&(o.publishedAt=new Date);let[n]=await p.db.update(u.opportunities).set({...o,updatedAt:new Date}).where((0,d.eq)(u.opportunities.id,r)).returning();return a.NextResponse.json({message:"Opportunity updated successfully",opportunity:n})}catch(e){return a.NextResponse.json({error:"Failed to update opportunity"},{status:500})}}async function m(e,{params:t}){try{let e=await (0,l.getServerSession)(g.L);if(!e?.user?.id)return a.NextResponse.json({error:"Unauthorized"},{status:401});let i=t.id,[r]=await p.db.select().from(u.opportunities).where((0,d.eq)(u.opportunities.id,i)).limit(1);if(!r)return a.NextResponse.json({error:"Opportunity not found"},{status:404});if(!(r.createdBy===e.user.id||e.user.organizationId&&e.user.organizationId===r.organizationId&&"organization_admin"===e.user.role))return a.NextResponse.json({error:"Unauthorized to delete this opportunity"},{status:403});return await p.db.update(u.opportunities).set({status:"cancelled",updatedAt:new Date}).where((0,d.eq)(u.opportunities.id,i)),a.NextResponse.json({message:"Opportunity deleted successfully"})}catch(e){return a.NextResponse.json({error:"Failed to delete opportunity"},{status:500})}}let q=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/opportunities/[id]/route",pathname:"/api/opportunities/[id]",filename:"route",bundlePath:"app/api/opportunities/[id]/route"},resolvedPagePath:"/Users/benknight/Code/JusticeHub/src/app/api/opportunities/[id]/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:w,staticGenerationAsyncStorage:h,serverHooks:f}=q,z="/api/opportunities/[id]/route";function v(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:h})}},95456:(e,t,i)=>{i.d(t,{L:()=>p});var r=i(54674),o=i(89773),s=i(57745),n=i(75571),a=i.n(n);let p={providers:[(0,i(21474).Z)({clientId:process.env.AUTH0_CLIENT_ID||"",clientSecret:process.env.AUTH0_CLIENT_SECRET||"",issuer:process.env.AUTH0_ISSUER_BASE_URL||""})],session:{strategy:"jwt"},callbacks:{async jwt({token:e,user:t,account:i}){if(i&&t){e.accessToken=i.access_token;let n=t.id,a=await r.db.query.users.findFirst({where:(0,s.eq)(o.users.auth0Id,n)});if(!a){let[e]=await r.db.insert(o.users).values({auth0Id:n,email:t.email,name:t.name,role:"youth"}).returning();a=e}e.id=a.id,e.role=a.role}return e},session:async({session:e,token:t})=>(e.accessToken=t.accessToken,e.user&&(e.user.id=t.id,e.user.role=t.role),e)},secret:process.env.NEXTAUTH_SECRET};a()(p)}};var t=require("../../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),r=t.X(0,[8948,5972,2707,8384,6546,4674],()=>i(24733));module.exports=r})();